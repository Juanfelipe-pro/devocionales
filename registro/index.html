<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Espera - Despertando con el Esp√≠ritu Santo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <style>
        :root{--primary-blue:#022873;--primary-gold:#f2b705;--light-gold:rgba(242,183,5,0.1)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Montserrat',sans-serif;min-height:100vh;background:linear-gradient(180deg,#FFFFFF 15.38%,rgba(242,183,5,0.71) 38.94%,rgba(242,183,5,0.71) 63.92%,#022873 94.23%);background-attachment:fixed}
        .form-page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
        .form-container{background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-width:550px;width:100%;overflow:hidden}
        .form-header{background:linear-gradient(135deg,var(--primary-blue) 0%,#033399 100%);color:#fff;padding:30px;text-align:center}
        .form-header .icon{font-size:3rem;color:var(--primary-gold);margin-bottom:15px}
        .form-header h1{font-size:1.5rem;font-weight:700;margin-bottom:10px}
        .form-header p{font-size:0.9rem;opacity:0.9;margin-bottom:0}
        .badge-launch{display:inline-block;background:var(--primary-gold);color:var(--primary-blue);padding:5px 15px;border-radius:20px;font-size:0.75rem;font-weight:700;margin-top:15px}
        .form-body{padding:30px}
        .form-label{font-weight:600;color:var(--primary-blue);font-size:0.85rem;margin-bottom:5px}
        .required{color:#dc3545}
        .form-control,.form-select{border:2px solid #e0e0e0;border-radius:10px;padding:12px 15px;font-size:0.95rem;transition:all 0.3s}
        .form-control:focus,.form-select:focus{border-color:var(--primary-gold);box-shadow:0 0 0 3px rgba(242,183,5,0.2)}
        .form-control.is-invalid,.form-select.is-invalid{border-color:#dc3545}
        .form-control.is-valid,.form-select.is-valid{border-color:#198754}
        .invalid-feedback{font-size:0.8rem}
        .row-documento{display:flex;gap:10px}
        .row-documento .tipo-doc{flex:0 0 110px}
        .row-documento .num-doc{flex:1}
        .row-telefono{display:flex;gap:10px}
        .row-telefono .indicativo{flex:0 0 120px}
        .row-telefono .numero-tel{flex:1}
        .terms-box{background:var(--light-gold);border:1px solid var(--primary-gold);border-radius:10px;padding:15px;margin:20px 0}
        .terms-box .form-check-label{font-size:0.85rem;color:#333}
        .terms-box a{color:var(--primary-blue);font-weight:600}
        .btn-submit{background:linear-gradient(135deg,var(--primary-gold) 0%,#d4a005 100%);color:var(--primary-blue);border:none;border-radius:10px;padding:15px 30px;font-size:1rem;font-weight:700;width:100%;transition:all 0.3s;text-transform:uppercase;letter-spacing:1px}
        .btn-submit:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(242,183,5,0.4);color:var(--primary-blue)}
        .btn-submit:disabled{opacity:0.7;cursor:not-allowed;transform:none}
        .secure-note{text-align:center;margin-top:15px;font-size:0.8rem;color:#666}
        .secure-note i{color:var(--primary-gold)}
        .back-link{display:block;text-align:center;margin-top:15px;color:var(--primary-blue);text-decoration:none;font-size:0.9rem}
        .back-link:hover{text-decoration:underline}
        @media(max-width:576px){.form-header{padding:20px}.form-header h1{font-size:1.3rem}.form-body{padding:20px}.row-documento,.row-telefono{flex-direction:column;gap:0}.row-documento .tipo-doc,.row-documento .num-doc,.row-telefono .indicativo,.row-telefono .numero-tel{flex:1 1 100%;margin-bottom:10px}}
    </style>
</head>
<body>
    <main class="form-page">
        <div class="form-container">
            <div class="form-header">
                <div class="icon"><i class="bi bi-dove"></i></div>
                <h1>Acceso Anticipado</h1>
                <p>S√© de los primeros en vivir este camino espiritual</p>
                <span class="badge-launch"><i class="bi bi-calendar-event me-1"></i>Lanzamiento: 5 de Febrero 2025</span>
            </div>
            <div class="form-body">
                <form id="waitlistForm" novalidate>
                    <div class="mb-3">
                        <label class="form-label">Documento de Identidad <span class="required">*</span></label>
                        <div class="row-documento">
                            <div class="tipo-doc">
                                <select class="form-select" id="tipoDocumento" required>
                                    <option value="">Tipo</option>
                                    <option value="CC">CC</option>
                                    <option value="CE">CE</option>
                                    <option value="TI">TI</option>
                                    <option value="PA">PA</option>
                                </select>
                            </div>
                            <div class="num-doc">
                                <input type="text" class="form-control" id="numeroDocumento" placeholder="N√∫mero de documento" required>
                                <div class="invalid-feedback" id="docFeedback">Ingresa tu documento</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre(s) <span class="required">*</span></label>
                            <input type="text" class="form-control" id="nombre" placeholder="Ej: Mar√≠a Jos√©" required>
                            <div class="invalid-feedback">M√≠nimo 2 caracteres</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Apellido(s) <span class="required">*</span></label>
                            <input type="text" class="form-control" id="apellido" placeholder="Ej: Garc√≠a L√≥pez" required>
                            <div class="invalid-feedback">M√≠nimo 2 caracteres</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Correo Electr√≥nico <span class="required">*</span></label>
                        <input type="email" class="form-control" id="email" placeholder="tu@correo.com" required>
                        <div class="invalid-feedback">Correo inv√°lido</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">WhatsApp / Celular <span class="required">*</span></label>
                        <div class="row-telefono">
                            <div class="indicativo">
                                <select class="form-select" id="indicativoPais">
                                    <option value="+57">üá®üá¥ +57</option>
                                    <option value="+1">üá∫üá∏ +1</option>
                                    <option value="+34">üá™üá∏ +34</option>
                                    <option value="+52">üá≤üáΩ +52</option>
                                    <option value="+51">üáµüá™ +51</option>
                                    <option value="+54">üá¶üá∑ +54</option>
                                    <option value="+56">üá®üá± +56</option>
                                    <option value="+593">üá™üá® +593</option>
                                    <option value="+58">üáªüá™ +58</option>
                                    <option value="+507">üáµüá¶ +507</option>
                                </select>
                            </div>
                            <div class="numero-tel">
                                <input type="tel" class="form-control" id="telefono" placeholder="3001234567" required>
                                <div class="invalid-feedback">M√≠nimo 7 d√≠gitos</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ciudad</label>
                        <input type="text" class="form-control" id="ciudad" placeholder="Ej: Barranquilla (opcional)">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">¬øC√≥mo nos conociste?</label>
                        <select class="form-select" id="referido">
                            <option value="">Selecciona (opcional)</option>
                            <option value="redes_sociales">Redes Sociales</option>
                            <option value="amigo">Un amigo me cont√≥</option>
                            <option value="parroquia">Mi parroquia</option>
                            <option value="comunidad">Comunidad Sembradores de Fe</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div class="terms-box">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="aceptaTerminos" required>
                            <label class="form-check-label" for="aceptaTerminos">
                                Acepto la <a href="#" id="verPolitica">Pol√≠tica de Tratamiento de Datos</a> seg√∫n la Ley 1581 de 2012.
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-submit" id="btnSubmit">
                        <i class="bi bi-check-circle me-2"></i>Reservar mi lugar
                    </button>
                    <p class="secure-note"><i class="bi bi-shield-lock-fill me-1"></i>Tus datos est√°n protegidos.</p>
                    <a href="../" class="back-link"><i class="bi bi-arrow-left me-1"></i>Volver al inicio</a>
                </form>
            </div>
        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
    (function(){
        // ========== CONFIGURACI√ìN ==========
        const API_URL = 'http://localhost:8000';
        const API_KEY = 'a7f3e9b1c4d8f2a6e0b5c9d3f7a1e4b8c2d6f0a9e3b7c1d5f8a2e6b0c4d9f3a7';
        
        const $ = id => document.getElementById(id);
        const campos = {
            tipoDocumento: $('tipoDocumento'),
            numeroDocumento: $('numeroDocumento'),
            nombre: $('nombre'),
            apellido: $('apellido'),
            email: $('email'),
            indicativoPais: $('indicativoPais'),
            telefono: $('telefono'),
            ciudad: $('ciudad'),
            referido: $('referido'),
            aceptaTerminos: $('aceptaTerminos')
        };
        
        const validar = {
            nombre: v => v.trim().length < 2 ? 'M√≠nimo 2 caracteres' : !/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s\-']+$/.test(v.trim()) ? 'Solo letras' : null,
            apellido: v => v.trim().length < 2 ? 'M√≠nimo 2 caracteres' : !/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s\-']+$/.test(v.trim()) ? 'Solo letras' : null,
            email: v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v.trim()) ? null : 'Correo inv√°lido',
            telefono: v => { const l = v.replace(/\D/g,''); return l.length < 7 || l.length > 15 ? '7-15 d√≠gitos' : null; },
            documento: (t,n) => {
                if(!t) return 'Selecciona tipo';
                const num = n.replace(/[\s\-\.]/g,'');
                if(t==='CC') return !/^\d{6,10}$/.test(num) ? 'CC: 6-10 d√≠gitos' : null;
                if(t==='CE') return !/^[a-zA-Z0-9]{6,7}$/.test(num) ? 'CE: 6-7 caracteres' : null;
                if(t==='TI') return !/^\d{10,11}$/.test(num) ? 'TI: 10-11 d√≠gitos' : null;
                if(t==='PA') return !/^[a-zA-Z0-9]{5,15}$/.test(num) ? 'Pasaporte: 5-15 caracteres' : null;
                return null;
            }
        };
        
        function marcar(campo, err) {
            const fb = campo.nextElementSibling;
            if(err) { campo.classList.remove('is-valid'); campo.classList.add('is-invalid'); if(fb?.classList.contains('invalid-feedback')) fb.textContent = err; return false; }
            campo.classList.remove('is-invalid'); campo.classList.add('is-valid'); return true;
        }
        
        function validarDoc() {
            const t = campos.tipoDocumento.value, n = campos.numeroDocumento.value, err = validar.documento(t,n);
            if(!t) campos.tipoDocumento.classList.add('is-invalid'); else { campos.tipoDocumento.classList.remove('is-invalid'); campos.tipoDocumento.classList.add('is-valid'); }
            if(err && t) { campos.numeroDocumento.classList.remove('is-valid'); campos.numeroDocumento.classList.add('is-invalid'); $('docFeedback').textContent = err; return false; }
            if(t && n) { campos.numeroDocumento.classList.remove('is-invalid'); campos.numeroDocumento.classList.add('is-valid'); return true; }
            return false;
        }
        
        campos.nombre.addEventListener('blur', function(){ marcar(this, validar.nombre(this.value)); });
        campos.apellido.addEventListener('blur', function(){ marcar(this, validar.apellido(this.value)); });
        campos.email.addEventListener('blur', function(){ marcar(this, validar.email(this.value)); });
        campos.telefono.addEventListener('input', function(){ this.value = this.value.replace(/\D/g,''); });
        campos.telefono.addEventListener('blur', function(){ marcar(this, validar.telefono(this.value)); });
        campos.tipoDocumento.addEventListener('change', validarDoc);
        campos.numeroDocumento.addEventListener('blur', validarDoc);
        
        $('verPolitica').addEventListener('click', function(e){
            e.preventDefault();
            Swal.fire({ title:'Pol√≠tica de Datos', html:'<div style="text-align:left;font-size:0.9rem"><p><b>Ley 1581 de 2012</b></p><p><b>Responsable:</b> Sembradores de Fe</p><hr><p>Al registrarte autorizas recolectar, tratar y almacenar tus datos. Tienes derecho a conocer, actualizar, rectificar y eliminar tus datos.</p></div>', icon:'info', confirmButtonText:'Entendido', confirmButtonColor:'#022873' });
        });
        
        $('waitlistForm').addEventListener('submit', async function(e){
            e.preventDefault();
            let ok = true;
            if(validar.nombre(campos.nombre.value)){ marcar(campos.nombre, validar.nombre(campos.nombre.value)); ok=false; }
            if(validar.apellido(campos.apellido.value)){ marcar(campos.apellido, validar.apellido(campos.apellido.value)); ok=false; }
            if(validar.email(campos.email.value)){ marcar(campos.email, validar.email(campos.email.value)); ok=false; }
            if(validar.telefono(campos.telefono.value)){ marcar(campos.telefono, validar.telefono(campos.telefono.value)); ok=false; }
            if(!validarDoc()) ok=false;
            if(!campos.aceptaTerminos.checked){ campos.aceptaTerminos.classList.add('is-invalid'); ok=false; } else campos.aceptaTerminos.classList.remove('is-invalid');
            
            if(!ok){ Swal.fire({ icon:'warning', title:'Campos incompletos', text:'Completa todos los campos requeridos.', confirmButtonColor:'#022873' }); return; }
            
            const datos = {
                tipo_documento: campos.tipoDocumento.value,
                numero_documento: campos.numeroDocumento.value.replace(/[\s\-\.]/g,''),
                nombre: campos.nombre.value.trim(),
                apellido: campos.apellido.value.trim(),
                email: campos.email.value.trim().toLowerCase(),
                indicativo_pais: campos.indicativoPais.value,
                telefono: campos.telefono.value.replace(/\D/g,''),
                ciudad: campos.ciudad.value.trim() || null,
                referido: campos.referido.value || null,
                acepta_terminos: true
            };
            
            const btn = $('btnSubmit');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Registrando...';
            
            try {
                const res = await fetch(`${API_URL}/api/waitlist`, {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json', 'X-API-Key':API_KEY },
                    body: JSON.stringify(datos)
                });
                const result = await res.json();
                
                if(res.ok){
                    const fecha = result.data?.fecha_registro ? new Date(result.data.fecha_registro).toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'}) : new Date().toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});
                    
                    Swal.fire({
                        icon: 'success',
                        title: '¬°Qu√© alegr√≠a tenerte aqu√≠!',
                        html: `<div style="text-align:center;color:#333">
                            <p style="margin-bottom:15px">Tu registro fue recibido y ya haces parte de la lista de espera de<br><b style="color:#022873">Despertando con el Esp√≠ritu Santo</b>.</p>
                            <p style="margin-bottom:15px">Muy pronto iniciaremos este recorrido de crecimiento espiritual.<br>Mientras tanto, deja que Dios siga preparando tu coraz√≥n.</p>
                            <p style="font-weight:600;color:#022873;margin-bottom:15px">Somos tu comunidad<br>Sembradores de Fe üïäÔ∏è</p>
                            <hr style="border-color:#f2b705">
                            <p style="font-size:0.85rem;color:#666">üìÖ ${fecha}<br>üìß ${datos.email}</p>
                            <p style="font-size:0.8rem;color:#999;margin-top:10px">Redirigiendo en <b id="cuenta">5</b>s...</p>
                        </div>`,
                        timer: 5000,
                        timerProgressBar: true,
                        showConfirmButton: false,
                        allowOutsideClick: false,
                        didOpen: () => {
                            let s = 5;
                            const intervalo = setInterval(() => { s--; const el = document.getElementById('cuenta'); if(el) el.textContent = s; }, 1000);
                            setTimeout(() => clearInterval(intervalo), 5000);
                        }
                    }).then(() => { window.location.href = '../'; });
                } else if(res.status === 409){
                    Swal.fire({ icon:'info', title:'Ya est√°s registrado', text:result.detail||'Este correo o documento ya est√° en la lista.', confirmButtonColor:'#022873' });
                } else {
                    Swal.fire({ icon:'error', title:'Error', text:result.detail||'Verifica los datos.', confirmButtonColor:'#022873' });
                }
            } catch(err){
                Swal.fire({ icon:'error', title:'Error de conexi√≥n', text:'No pudimos conectar con el servidor.', confirmButtonColor:'#022873' });
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Reservar mi lugar';
            }
        });
    })();
    </script>
</body>
</html>
